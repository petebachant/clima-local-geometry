==========================================
LocalGeometry CUDA Benchmark - SLURM Job
==========================================
Job ID: 189584
Node: clima
Start time: Mon Feb 23 13:28:12 PST 2026

Julia version:
julia version 1.11.5

CUDA devices available:
name, memory.total [MiB]
NVIDIA A100-SXM4-80GB, 81920 MiB
NVIDIA A100-SXM4-80GB, 81920 MiB
NVIDIA A100-SXM4-80GB, 81920 MiB
NVIDIA A100-SXM4-80GB, 81920 MiB
NVIDIA A100-SXM4-80GB, 81920 MiB
NVIDIA A100-SXM4-80GB, 81920 MiB
NVIDIA A100-SXM4-80GB, 81920 MiB
NVIDIA A100-SXM4-80GB, 81920 MiB

Julia project: /home/pbachant/calkit/clima-local-geometry/ClimaCore.jl/.buildkite

Instantiating Julia environment...
==========================================
┌ Warning: The active manifest file has dependencies that were resolved with a different julia version (1.10.8). Unexpected behavior may occur.
└ @ ~/calkit/clima-local-geometry/ClimaCore.jl/.buildkite/Manifest.toml:0
┌ Warning: The project dependencies or compat requirements have changed since the manifest was last resolved.
│ It is recommended to `Pkg.resolve()` or consider `Pkg.update()` if necessary.
└ @ Pkg.API /clima/software/julia/julia-1.11.5/share/julia/stdlib/v1.11/Pkg/src/API.jl:1206
Precompiling project...
   8644.7 ms  ✓ ClimaCore
  10954.2 ms  ✓ ClimaCore → KrylovExt
  11030.0 ms  ✓ ClimaCoreVTK
  10836.8 ms  ✓ ClimaCorePlots
  11947.7 ms  ✓ ClimaCoreTempestRemap
  15651.3 ms  ✓ ClimaCore → ClimaCoreCUDAExt
  6 dependencies successfully precompiled in 29 seconds. 480 already precompiled.

Running benchmark...
==========================================

======================================================================
LOCALGEOMETRY CUDA KERNEL PERFORMANCE BENCHMARK
======================================================================

======================================================================
INLINING VERIFICATION
======================================================================

Sizeof checks (should help predict inlining threshold):
  LocalGeometry field element:  8 bytes
  TwoFieldGeom:                 16 bytes
  FourFieldGeom:                32 bytes
  EightFieldGeom:               64 bytes
  SixteenFieldGeom:             128 bytes

Note: CUDA typically inlines structs < 128 bytes effectively

======================================================================
SECTION 1: Basic Geometry Access Patterns
======================================================================

SECTION 2: Testing impact of struct size on inlining

SECTION 3: Testing projection operations (common in physics kernels)

Running benchmarks (this takes ~2-3 minutes)...

(1/12) benchmarking "6_two_field_access"...
done (took 1.199856009 seconds)
(2/12) benchmarking "1_baseline_simple"...
done (took 0.63008831 seconds)
(3/12) benchmarking "10_vector_baseline"...
done (took 1.290935692 seconds)
(4/12) benchmarking "8_eight_field_access"...
done (took 0.627955389 seconds)
(5/12) benchmarking "2_full_lg_jacobian"...
done (took 0.621246679 seconds)
(6/12) benchmarking "7_four_field_access"...
done (took 0.673520206 seconds)
(7/12) benchmarking "3_full_lg_multiple"...
done (took 1.155195047 seconds)
(8/12) benchmarking "5_simplified_lg"...
done (took 1.027989095 seconds)
(9/12) benchmarking "12_multiple_scalar_access"...
done (took 1.26228355 seconds)
(10/12) benchmarking "11_project_full_lg"...
done (took 1.860646241 seconds)
(11/12) benchmarking "9_sixteen_field_access"...
done (took 0.653462636 seconds)
(12/12) benchmarking "4_extracted_j"...
done (took 0.612283549 seconds)

======================================================================
BENCHMARK RESULTS
======================================================================

SECTION 1: Basic Geometry Access
----------------------------------------------------------------------

Execution Time (μs, lower is better):
  baseline_simple                     16.07 μs  (  +0.0% vs baseline)
  full_lg_jacobian                    17.27 μs  (  +7.5% vs baseline)
  full_lg_multiple                    19.53 μs  ( +21.5% vs baseline)
  extracted_j                         17.13 μs  (  +6.6% vs baseline)
  simplified_lg                       17.21 μs  (  +7.1% vs baseline)

----------------------------------------------------------------------
SECTION 2: Struct Size Impact on Inlining
----------------------------------------------------------------------

Execution Time (μs, lower is better):
  two_field_access                    17.34 μs  (  +7.9% vs baseline)
  four_field_access                   17.43 μs  (  +8.5% vs baseline)
  eight_field_access                  16.91 μs  (  +5.2% vs baseline)
  sixteen_field_access                17.05 μs  (  +6.1% vs baseline)

----------------------------------------------------------------------
SECTION 3: Projection Operations
----------------------------------------------------------------------

Execution Time (μs, lower is better):
  vector_baseline                     17.30 μs  (  +0.0% vs vec_baseline)
  project_full_lg                     17.61 μs  (  +1.8% vs vec_baseline)
  multiple_scalar_access              19.19 μs  ( +10.9% vs vec_baseline)

======================================================================
MEMORY FOOTPRINT COMPARISON
======================================================================

Data structure size per point:
  Scalar field:                    128.0 bytes
  TwoFieldGeom:                    256.0 bytes
  FourFieldGeom:                   512.0 bytes
  EightFieldGeom:                  1024.0 bytes
  SixteenFieldGeom:                2048.0 bytes
  Full LocalGeometry:              2688.0 bytes
  Extracted J:                     128.0 bytes

Total memory footprint:
  Scalar field:                    0.0001220703125 MB
  TwoFieldGeom:                    0.000244140625 MB (2.0x scalar)
  FourFieldGeom:                   0.00048828125 MB (4.0x scalar)
  EightFieldGeom:                  0.0009765625 MB (8.0x scalar)
  SixteenFieldGeom:                0.001953125 MB (16.0x scalar)
  Full LocalGeometry:              0.0025634765625 MB (21.0x scalar)
  Extracted J:                     0.0001220703125 MB (1.0x scalar)

======================================================================
ANALYSIS & KEY FINDINGS
======================================================================

1. BASIC GEOMETRY ACCESS OVERHEAD:
   Full LocalGeometry (J only):      7.5%
   Extracted J:                      6.6%

2. STRUCT SIZE IMPACT (accessing single field):
   TwoFieldGeom (16 bytes):          7.9%
   FourFieldGeom (32 bytes):         8.5%
   EightFieldGeom (64 bytes):        5.2%
   SixteenFieldGeom (128 bytes):     6.1%

   ✓ All struct sizes show similar performance - good inlining

3. PROJECTION OPERATIONS OVERHEAD:
   Covariant->Contravariant:         1.8%

======================================================================
RECOMMENDATIONS
======================================================================

⚠️  MODERATE OVERHEAD DETECTED:
   • LocalGeometry overhead: 7.5%
   • Projection overhead: 1.8%

   CONSIDER:
   1. Extract commonly-used components (J, WJ) at kernel entry
   2. Profile with nsys to see actual bandwidth/occupancy impact:
      ./scripts/run-nsys.sh --output=results/nsys/benchmark_lg \
          julia --project scripts/benchmark_local_geometry_impact.jl

======================================================================
CODE INSPECTION NOTES
======================================================================
To verify compiler inlining behavior:

1. Check LLVM IR for a simple kernel:
   julia> f(x, lg) = x + lg.J
   julia> @code_llvm f(1.0, first(local_geom_full))

   Look for: Should see direct field access, not function calls

2. Check PTX assembly for CUDA kernels:
   julia> using CUDA
   julia> kernel(x, lg) = (@inbounds x[1] += lg[1].J; nothing)
   julia> @device_code_ptx kernel(CuArray([1.0]), parent(local_geom_full))

   Look for: ld.param instructions (should be minimal for inlined structs)

3. Use nsys to profile actual memory bandwidth:
   ./scripts/run-nsys.sh --output=results/nsys/benchmark_lg \
       julia --project scripts/benchmark_local_geometry_impact.jl

   Then analyze with:
   nsys stats results/nsys/benchmark_lg.nsys-rep

   Look for: Memory bandwidth utilization, kernel occupancy

======================================================================

Markdown results written to: /home/pbachant/calkit/clima-local-geometry/scripts/../results/benchmark_local_geometry_impact.md

==========================================
Benchmark complete
End time: Mon Feb 23 13:29:45 PST 2026
==========================================
